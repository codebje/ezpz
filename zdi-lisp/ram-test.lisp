;;;
(defun hexb (x) (format t "~2,'0x" x))

(defun zdi-rw-read (var)
  (when (>= 7 var 0)
    (zdi! #x16 var)
    (logior (ash (zdi? #x12) 16)
            (ash (zdi? #x11) 8)
            (zdi? #x10))))

(defun ram-setup ()
  (out #xa8 #x00)
  (out #xa9 #x07)
  (out #xaa #x08)
  (out #xb5 #xff)
  (out #xf7 #x08))

(defun flash ()
  (zdi! #x16 #x08)
  (out #xf5 #xb6)
  (out #xf5 #x49)
  (out #xf9 #xff)
  (out #xf5 #xb6)
  (out #xf5 #x49)
  (out #xfa #x00)
  (zdi! #x13 #x00)
  (zdi! #x14 #xe0)
  (zdi! #x15 #xff)
  (zdi! #x16 #x87)
  (mapc (lambda (x) (zdi! #x30 x))
        (list
         #xed #x38 #xfb
         #x11 #x00 #x00 #x08
         #x21 #x00 #x00 #x00
         #x01 #x00 #x00 #x04
         #xed #xb0
         #x18 #xfe))
  (zdi! #x13 #x00)
  (zdi! #x14 #xe0)
  (zdi! #x15 #xff)
  (zdi! #x16 #x87)
  (run))

(defun erase()
  (out #xf5 #xb6)
  (out #xf5 #x49)
  (out #xf9 #xff)
  (out #xf5 #xb6)
  (out #xf5 #x49)
  (out #xfa #x00)
  (out #xff #x01))

(defun lockf()
  (out #xf5 #xb6)
  (out #xf5 #x49)
  (out #xfa #xff))

(defun again ()
  (stop)
  (brk 0 #x12b)
  (brk 1 #x14b)
  (zdi! #x13 0) (zdi! #x14 1) (zdi! #x15 0) (zdi! #x16 #x87)
  (exec #x21 #x10 #x32 #x54)
  (exec #x22 #x00 #xe0 #xff)
  (exec #x21 #x76 #x98 #xba)
  (exec #x22 #x03 #xe0 #xff)
  (exec #x21 #xdc #xfe #x00)
  (exec #x22 #x06 #xe0 #xff)
  (exec #x21 #x00 #x40 #x00)
  (exec #x22 #x08 #xe0 #xff)
  (exec #x21 #x00 #x00 #x00)
  (exec #x22 #x0b #xe0 #xff)
  (exec #x22 #x0e #xe0 #xff)
  (exec #x31 #x18 #x00 #x01)
  (exec #x21 #x00 #xe0 #xff)
  (exec #x01 #x08 #xe0 #xff))

(defun vars () (mem #x10000))
(defun more () (step)(run)(regs)(vars))
